#  1 引言

各种各样的应用程序都在使用 Java 平台标准版（Java SE），从桌面端的小程序到大型服务器上的 Web 服务。为了支持这种多样化的部署，Java HotSpot 虚拟机实现（Java HotSpot VM）提供了多种垃圾回收器，每种都旨在满足不同的需求。这是满足大小应用程序需求的重要组成部分。Java SE 根据运行应用程序的计算机类别选择最合适的垃圾回收器。然而，这种选择可能并非对每个应用程序都是最优的。有严格性能目标或其他要求的用户、开发人员和管理员可能需要显式选择垃圾回收器并调整某些参数，以达到期望的性能水平。本文档提供了有助于完成这些任务的信息。首先，在串行的“停止世界”回收器(stop-the-world collector)的背景下描述了垃圾回收器的一般特性和基本调优选项。然后介绍了其他回收器的特定特性，以及选择回收器时需要考虑的因素。

垃圾回收器（GC）是一种内存管理工具。它通过以下操作实现自动内存管理：

- 将对象分配到新生代，并将老化的对象提升到老年代。
- 通过并发（并行）标记阶段在老年代中查找存活对象。当 Java 堆总占用量超过默认阈值时，Java HotSpot 虚拟机将触发标记阶段。请参阅“并发标记清除（CMS）收集器”和“G1 垃圾收集器”部分。
- 通过并行复制压缩存活对象来回收空闲内存。请参阅“并行收集器”和“G1 垃圾收集器”部分。

垃圾收集器的选择何时会产生影响呢？对于某些应用程序而言，答案是永远不会。也就是说，在垃圾回收以适度的频率和时长暂停的情况下，应用程序仍能良好运行。然而，对于一大类应用程序来说并非如此，尤其是那些处理大量数据（数 GB）、拥有众多线程且事务率较高的应用程序。

阿姆达尔定律(Amdahl's law)（给定问题中的并行加速受问题的顺序执行部分限制）表明，大多数工作负载无法实现完美的并行化；总有一部分是顺序执行的，无法从并行处理中受益。Java 平台也是如此。特别是，Oracle 为 Java 平台提供的 Java SE 1.4 之前的虚拟机不支持并行垃圾回收，因此在多处理器系统中，垃圾回收对原本并行的应用程序的影响会相对增大。

图 1 - 1“垃圾回收时间占比对比”中的图表模拟了一个理想系统，该系统除垃圾回收（GC）外具有完美的可扩展性。红线表示在单处理器系统中仅将 1%的时间用于垃圾回收的应用程序。在拥有 32 个处理器的系统中，这意味着吞吐量损失超过 20%。品红色线显示，对于将 10%的时间用于垃圾回收的应用程序（在单处理器应用程序中，这一垃圾回收时间占比不算离谱），当扩展到 32 个处理器时，吞吐量损失超过 75%。

***图 1 - 1 垃圾回收所花费时间的百分比比较\***

![Description of Figure 1-1 follows](./assets/README/jsgct_dt_005_gph_pc_vs_tp.png)

[“图 1 - 1 垃圾回收所花费时间的百分比比较”说明](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/img_text/jsgct_dt_005_gph_pc_vs_tp.html)

*该图表对一个理想系统进行了建模，该系统除垃圾回收（GC）外具有完美的可扩展性。它以处理器数量（x 轴）为横轴，吞吐量（y 轴）为纵轴进行绘制。图表中有六条绘制的线，分别标记为 1% GC、2% GC、3% GC、10% GC、20% GC 和 30% GC。每条线代表一个应用程序在单处理器系统和多处理器系统上，花费指定百分比的时间用于垃圾回收时吞吐量的变化情况。该图表在其前面的文本中有描述。*

这表明，在小型系统上进行开发时可忽略不计的速度问题，在扩展到大型系统时可能会成为主要瓶颈。然而，在减少此类瓶颈方面的微小改进可能会带来性能上的大幅提升。对于足够大的系统而言，选择合适的垃圾回收器并在必要时对其进行调优是值得的。

串行收集器通常足以满足大多数“小型”应用程序的需求（这些应用程序在现代处理器上所需的堆大小最多约为 100 兆字节 (MB)）。其他收集器有额外的开销或复杂性，这是实现特定行为所付出的代价。如果应用程序不需要其他收集器的特定行为，则使用串行收集器。有一种情况不适合选择串行收集器，即运行在具有大量内存和两个或更多处理器的机器上的大型、多线程应用程序。当应用程序在这类服务器级机器上运行时，默认会选择并行收集器。请参阅“自动调优”部分。

本文档以在 Solaris 操作系统（SPARC 平台版本）上使用 Java SE 8 进行开发为参考。不过，本文中介绍的概念和建议适用于所有受支持的平台，包括 Linux、Microsoft Windows、Solaris 操作系统（x64 平台版本）和 OS X。此外，文中提及的命令行选项在所有受支持的平台上均可用，尽管某些选项的默认值在不同平台上可能有所不同。