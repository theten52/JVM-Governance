# G1 垃圾收集器调优

原文链接：https://www.oracle.com/technical-resources/articles/java/g1gc.html

*作者：莫妮卡·贝克威思*
2013 年 8 月发布

- [Java](https://www.oracle.com/java/)
- [技术细节](https://www.oracle.com/java/technologies/)

**了解如何针对评估、分析和性能对 G1 垃圾回收器（G1 GC）进行调整和优化。**

G1 垃圾回收器（Garbage First Garbage Collector，G1 GC）是用于 Java HotSpot 虚拟机的低停顿、服务器风格的分代垃圾回收器。G1 GC 使用并发和并行阶段来实现其目标停顿时间并保持良好的吞吐量。当 G1 GC 确定需要进行垃圾回收时，它会首先回收存活数据最少的区域（先处理垃圾）。

垃圾回收器（GC）是一种内存管理工具。G1 垃圾回收器通过以下操作实现自动内存管理：

- 将对象分配到新生代，并将老化的对象提升到老年代。
- 通过并发（并行）标记阶段在老年代中查找存活对象。当 Java 堆总占用量超过默认阈值时，Java HotSpot 虚拟机将触发标记阶段。
- 通过并行复制压缩存活对象来回收空闲内存。

在这里，我们将探讨如何为评估、分析和性能调优来适配和调整 G1 垃圾收集器（GC） —— 我们假设你对 Java 垃圾回收有基本的了解。

G1 垃圾回收器是一种分区域、分代的垃圾回收器，这意味着 Java 对象堆（堆）被划分为多个大小相等的区域。启动时，Java 虚拟机（JVM）会设置区域大小。区域大小可根据堆大小在 1MB 到 32MB 之间变化。目标是区域数量不超过 2048 个。Eden 区、幸存者区和老年代是这些区域的逻辑集合，它们并不连续。

G1 垃圾回收器（G1 GC）有一个它试图达成的停顿时间目标（软实时）。在新生代垃圾回收期间，G1 GC 会调整其新生代（Eden 区和幸存者区大小）以实现软实时目标。在混合垃圾回收期间，G1 GC 会根据混合垃圾回收的目标次数、堆中每个区域的存活对象百分比以及总体可接受的堆空间浪费百分比，来调整要回收的老年代区域数量。

G1 垃圾回收器（G1 GC）通过将存活对象从一个或多个区域集合（称为收集集（CSet））以增量并行复制的方式复制到不同的新区域来减少堆碎片化，从而实现堆内存的紧凑。其目标是尽可能多地回收堆空间，从包含最多可回收空间的区域开始，同时尽量不超过停顿时间目标（优先处理垃圾）。

G1 垃圾回收器（G1 GC）使用独立的记忆集（RSets）来跟踪指向区域的引用。独立的记忆集支持对区域进行并行且独立的回收，因为只需扫描某个区域的记忆集来查找指向该区域的引用，而无需扫描整个堆。G1 垃圾回收器使用写后屏障来记录堆的变化并更新记忆集。

#### 垃圾回收阶段

除了构成“Stop-the-World”（STW）新生代和混合垃圾回收的疏散暂停（如下所述）之外，G1 垃圾收集器（G1 GC）还有并行、并发和多阶段的标记周期。G1 GC 使用“起始快照”（Snapshot-At-The-Beginning，SATB）算法，该算法在标记周期开始时对堆中的存活对象集进行快照。存活对象集由快照中的存活对象以及自标记周期开始以来分配的对象组成。G1 GC 标记算法使用写前屏障来记录和标记属于逻辑快照一部分的对象。

#### 新生代垃圾回收

G1 垃圾回收器（G1 GC）会满足大多数来自添加到 Eden 区域集的区域的分配请求。在一次新生代垃圾回收期间，G1 GC 会回收 Eden 区域以及上一次垃圾回收中的幸存者区域。来自 Eden 区域和幸存者区域的存活对象会被复制或转移到一组新的区域。某个特定对象的目标区域取决于该对象的年龄；年龄足够大的对象会转移到老年代区域（即晋升）；否则，该对象会转移到幸存者区域，并会被包含在下一次新生代或混合垃圾回收的收集集（CSet）中。

#### 混合垃圾回收

在并发标记周期成功完成后，G1 垃圾回收器（G1 GC）会从执行新生代垃圾回收切换到执行混合垃圾回收。在混合垃圾回收中，G1 垃圾回收器会选择性地将一些老年代区域添加到即将被回收的 Eden 区和幸存者区集合中。添加的老年代区域的确切数量由多个标志控制，这些标志将在后面讨论（请参阅“控制混合垃圾回收”）。在 G1 垃圾回收器回收了足够数量的老年代区域（经过多次混合垃圾回收）后，G1 会恢复执行新生代垃圾回收，直到下一个标记周期完成。

#### 标记周期的阶段

标记周期有以下阶段：

- 初始标记阶段：在此阶段，G1 垃圾收集器（G1 GC）标记根对象。此阶段搭载在正常的（STW）新生代垃圾回收过程中。
- 根区域扫描阶段：G1 垃圾回收器会扫描初始标记阶段的幸存者区域，查找指向老年代的引用，并标记被引用的对象。此阶段与应用程序并发运行（非 STW），并且必须在下一次 STW 新生代垃圾回收开始之前完成。
- 并发标记阶段：G1 垃圾收集器会在整个堆中查找可触及（存活）的对象。此阶段与应用程序并发执行，并且可能会被 STW 新生代垃圾回收中断。
- 标记阶段：此阶段为 STW（Stop The World）收集阶段，有助于完成标记周期。G1 垃圾回收器会清空 SATB（Snapshot At The Beginning）缓冲区，追踪未访问的存活对象，并执行引用处理。
- 清理阶段：在这个最后阶段，G1 垃圾回收器（G1 GC）会执行记账和 RSet 清理的 STW（Stop-The-World）操作。在记账过程中，G1 垃圾回收器会识别出完全空闲的区域和混合垃圾回收候选区域。当清理阶段重置空区域并将其返回到空闲列表时，该阶段部分是并发执行的。

#### 重要默认设置

G1 垃圾回收器（G1 GC）是一种自适应的垃圾回收器，其默认设置使其无需修改即可高效工作。以下是重要选项及其默认值的列表。此列表适用于最新的 Java HotSpot 虚拟机（版本构建号为 24）。你可以通过在 JVM 命令行中输入以下更改设置后的选项，根据应用程序的性能需求对 G1 GC 进行调整和优化。

- ```
  -XX:G1HeapRegionSize=n
  ```

  设置 G1 区域的大小。该值必须是 2 的幂，范围从 1MB 到 32MB。目标是根据最小 Java 堆大小设置大约 2048 个区域。
- ```
  -XX:MaxGCPauseMillis=200
  ```

  设置期望的最大暂停时间的目标值。默认值为 200 毫秒。指定的值不会根据你的堆大小进行调整。
- ```
  -XX:G1NewSizePercent=5
  ```

  设置用于新生代大小的堆百分比下限。默认值为 Java 堆的 5%。这是一个实验性标志。有关示例，请参阅“如何解锁实验性虚拟机标志”。此设置将取代 `-XX:DefaultMinNewGenPercent` 设置。Java HotSpot 虚拟机（版本 23）不支持此设置。
- ```
  -XX:G1MaxNewSizePercent=60
  ```

  设置用于新生代大小的堆大小的百分比上限。默认值为 Java 堆大小的 60%。这是一个实验性标志。有关示例，请参阅“如何解锁实验性虚拟机标志”。此设置将取代 `-XX:DefaultMaxNewGenPercent` 设置。Java HotSpot 虚拟机（版本 23）不支持此设置。
- ```
  -XX:ParallelGCThreads=n
  ```

  设置 STW 工作线程的值。将 n 的值设置为逻辑处理器的数量。 `n` 的值在不超过 8 时与逻辑处理器的数量相同。

  如果逻辑处理器数量超过八个，则将 `n` 的值设置为约为逻辑处理器数量的 5/8。这在大多数情况下都适用，但对于较大的 SPARC 系统除外，在这些系统中， `n` 的值可以约为逻辑处理器数量的 5/16。
- ```
  -XX:ConcGCThreads=n
  ```

  设置并行标记线程的数量。将 `n` 设置为并行垃圾回收线程数量（ `ParallelGCThreads` ）的大约四分之一。
- ```
  -XX:InitiatingHeapOccupancyPercent=45
  ```

  设置触发标记周期的 Java 堆占用阈值。默认占用率为整个 Java 堆的 45%。
- ```
  -XX:G1MixedGCLiveThresholdPercent=65
  ```

  设置旧区域要被纳入混合垃圾回收周期的占用阈值。默认占用率为 65%。这是一个实验性标志。有关示例，请参阅“如何解锁实验性虚拟机标志”。此设置将取代 `-XX:G1OldCSetRegionLiveThresholdPercent` 设置。Java HotSpot 虚拟机（版本 23）不支持此设置。
- ```
  -XX:G1HeapWastePercent=10
  ```

  设置您愿意浪费的堆内存百分比。当可回收百分比小于堆内存浪费百分比时，Java HotSpot 虚拟机不会启动混合垃圾回收周期。默认值为 10%。此设置在 Java HotSpot 虚拟机（版本 23）中不可用。
- ```
  -XX:G1MixedGCCountTarget=8
  ```

  将标记周期后混合垃圾回收的目标次数设置为收集存活数据最多为 `G1MixedGCLIveThresholdPercent` 的老年代区域。默认值是 8 次混合垃圾回收。混合回收的目标是在这个目标次数内完成。此设置在 Java HotSpot VM 构建版本 23 中不可用。
- ```
  -XX:G1OldCSetRegionThresholdPercent=10
  ```

  设置在混合垃圾回收周期中要回收的旧区域数量上限。默认值为 Java 堆的 10%。此设置在 Java HotSpot VM 构建版本 23 中不可用。
- ```
  -XX:G1ReservePercent=10
  ```

  设置保留的空闲内存百分比，以降低 to-space 溢出的风险。默认值为 10%。当您增加或减少该百分比时，请确保将 Java 堆总量调整相同的幅度。此设置在 Java HotSpot VM 构建版本 23 中不可用。

#### 如何解锁实验性虚拟机标志

要更改实验标志的值，您必须先解锁它们。您可以通过在任何实验标志之前在命令行上显式设置 `-XX:+UnlockExperimentalVMOptions` 来实现这一点。例如：

```
> java -XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75 G1test.jar
```

#### 建议；推荐；推荐信

在评估和微调 G1 垃圾回收器（G1 GC）时，请牢记以下建议：

- 新生代大小：避免使用 `-Xmn` 选项或任何其他相关选项（如 `-XX:NewRatio` ）显式设置新生代大小。固定新生代大小会覆盖目标暂停时间目标。
- 暂停时间目标：当你评估或调优任何垃圾回收时，始终存在延迟与吞吐量的权衡。G1 GC 是一种具有均匀暂停的增量式垃圾回收器，但会给应用程序线程带来更多开销。G1 GC 的吞吐量目标是 90% 的应用程序运行时间和 10% 的垃圾回收时间。与 Java HotSpot VM 的吞吐量收集器相比，后者的目标是 99% 的应用程序运行时间和 1% 的垃圾回收时间。因此，当你评估 G1 GC 的吞吐量时，应放宽暂停时间目标。设定过于激进的目标意味着你愿意承受垃圾回收开销的增加，这会直接影响吞吐量。当你评估 G1 GC 的延迟时，你可以设定所需的（软）实时目标，G1 GC 会尽力实现该目标。不过，这可能会导致吞吐量下降。
- 

  驯服混合垃圾回收：在调优混合垃圾回收时，尝试以下选项。有关这些选项的信息，请参阅“重要默认设置”。

- `-XX:InitiatingHeapOccupancyPercent`
  用于更改标记阈值。
- `-XX:G1MixedGCLiveThresholdPercent` 和 `-XX:G1HeapWastePercent`
  当你想改变混合垃圾回收决策时。
- `-XX:G1MixedGCCountTarget` 和 `-XX:G1OldCSetRegionThresholdPercent`
  当你想为旧区域调整 CSet 时。

#### 溢出和耗尽日志消息

当你在日志中看到“to-space 溢出/耗尽”消息时，G1 垃圾回收器（G1 GC）没有足够的内存来存放幸存者对象或晋升对象，或者两者都不够。由于 Java 堆已经达到最大容量，因此无法再进行扩展。示例消息：

```
924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space exhausted), 0.1957310 secs]
```

OR

```
924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space overflow), 0.1957310 secs]
```

为缓解该问题，请尝试以下调整：

增加 `-XX:G1ReservePercent` 选项的值（并相应地增加总堆大小），以增加 “to-space” 的预留内存量。

通过减少 `-XX:InitiatingHeapOccupancyPercent` 来提前开始标记周期。

你也可以增大 `-XX:ConcGCThreads` 选项的值，以增加并行标记线程的数量。

有关这些选项的描述，请参阅“重要默认设置”。

#### 巨型对象和巨型分配

对于 G1 垃圾回收器（GC），任何大小超过半个区域大小的对象都被视为“巨型对象”。此类对象会直接在老年代的“巨型区域”中分配。这些巨型区域是一组连续的区域。 `StartsHumongous` 标记连续区域集的起始位置， `ContinuesHumongous` 标记该区域集的延续部分。

在分配任何巨型区域之前，会检查标记阈值，必要时启动并发周期。

在标记周期结束后的清理阶段，以及在完整的垃圾回收周期中，死亡的巨型对象会被释放。

为了减少复制开销，巨型对象不包含在任何疏散暂停中。完整的垃圾回收周期会就地压缩巨型对象。

由于每一组“StartsHumongous”和“ContinuesHumongous”区域都仅包含一个巨型对象，因此巨型对象的末尾与该对象所跨越的最后一个区域的末尾之间的空间未被使用。对于那些仅比堆区域大小的倍数略大的对象，这种未使用的空间可能会导致堆碎片化。

如果您看到由于巨型分配而引发了连续的并发周期，并且此类分配正在使您的老年代产生碎片化，请增加您的 `-XX:G1HeapRegionSize` ，以使之前的巨型对象不再属于巨型对象，并将遵循常规的分配路径。

#### 结论

G1 垃圾回收器（G1 GC）是一种区域化、并行 - 并发、增量式的垃圾回收器，与其他 HotSpot 垃圾回收器相比，它能提供更可预测的停顿时间。其增量式特性使 G1 GC 能够处理更大的堆，同时仍能提供合理的最坏情况响应时间。G1 GC 的自适应特性只需要在 JVM 命令行上指定一个最大软实时停顿时间目标，以及所需的 Java 堆最大和最小大小。

#### 另请参阅

- [G1 垃圾回收器](https://www.oracle.com/java/technologies/javase/hotspot-garbage-collection.html) [DONE]
- [Java HotSpot 垃圾回收](https://www.oracle.com/java/technologies/javase/javase-core-technologies-apis.html) [本文下方附有内容]

#### 关于作者

莫妮卡·贝克威斯（Monica Beckwith）是甲骨文公司（Oracle）的技术骨干成员，担任 Java HotSpot 虚拟机的 G1 垃圾回收器（Garbage First Garbage Collector）性能负责人。她在性能和架构领域拥有超过 10 年的工作经验。在加入甲骨文和太阳微系统公司（Sun Microsystems）之前，莫妮卡曾在飞索半导体公司（Spansion Inc.）负责性能相关工作。莫妮卡参与过许多基于 Java 的行业标准基准测试，始终致力于在 Java HotSpot 虚拟机中寻找改进机会。

#### 加入对话

在 Facebook、Twitter 和甲骨文 Java 博客上参与 Java 社区的讨论吧！

---

##### Java HotSpot 垃圾回收

以下文档提供了有关 Java HotSpot 虚拟机中垃圾回收及相关问题的信息。

| 文档                                                                                                                                | 描述                                                                                                                                     |
| :---------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------- |
| [内存管理白皮书[pdf\]](https://www.oracle.com/technetwork/java/javase/tech/memorymanagement-whitepaper-1-150020.pdf) [已翻译，在12-03] | 包括垃圾回收（GC）概念概述、可用收集器的描述以及一些基本的调优技巧（更多调优细节见下面的调优指南）。                                     |
|                                                                                                                                     | 描述了默认运行时编译器、垃圾回收器和堆大小是如何选择的。（请注意，本文档是为 J2SE 5.0 版本编写的；不过，这些信息同样适用于 Java SE 6。） |
| [垃圾回收调优](https://www.oracle.com/java/technologies/javase/gc-tuning-6.html) 【忽略，Java6的版本，已翻译Java8的版本】              | 提供有关可用垃圾回收器的详细信息、在默认垃圾回收器不满足需求时选择回收器的指南，以及通过调整堆和垃圾回收参数来提高性能的建议。           |
| [如何处理 Java 终结机制的内存保留问题](http://www.devx.com/Java/Article/30192) 【已翻译，在12-05】                                     | 描述了 Java 中终结机制的一些陷阱，并介绍了避免这些陷阱的技术。                                                                           |
| [垃圾优先（“G1”）垃圾回收器](https://www.oracle.com/java/technologies/javase/hotspot-garbage-collection.html) [DONE]                 | 介绍了 Java HotSpot 虚拟机中全新的 G1 垃圾回收器。                                                                                       |
